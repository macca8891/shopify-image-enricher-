<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopify Image Processor - Working</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8fafc;
            color: #334155;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .main-content {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
        }

        .sidebar {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #374151;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }

        .btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: all 0.2s;
        }

        .btn:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }

        .btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6b7280;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-success {
            background: #10b981;
        }

        .btn-success:hover {
            background: #059669;
        }

        .product-grid {
            display: grid;
            gap: 15px;
        }

        .product-card {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            background: white;
            transition: all 0.2s;
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 15px;
            align-items: start;
        }

        .product-card:hover {
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .product-card.selected {
            border-color: #3b82f6;
            background: #f0f9ff;
        }

        .product-info {
            min-width: 0;
        }

        .product-title {
            font-size: 16px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 5px;
        }

        .product-meta {
            color: #64748b;
            font-size: 12px;
            margin-bottom: 10px;
        }

        .product-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .product-actions .btn {
            margin: 0;
            padding: 5px 10px;
            font-size: 12px;
        }

        .product-images {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 8px;
            min-width: 200px;
        }

        .image-item {
            width: 80px;
            height: 80px;
            border-radius: 4px;
            border: 2px solid transparent;
            cursor: pointer;
            overflow: hidden;
            transition: all 0.2s;
        }

        .image-item:hover {
            border-color: #3b82f6;
            transform: scale(1.05);
        }

        .image-item.selected {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .image-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .pagination-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin: 20px 0;
            padding: 15px;
            background: #f8fafc;
            border-radius: 8px;
        }

        .pagination-info {
            font-weight: 500;
            color: #374151;
        }

        .log-container {
            background: #1e293b;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 12px;
            line-height: 1.4;
        }

        .log-entry {
            margin-bottom: 3px;
            padding: 2px 0;
        }

        .log-timestamp {
            color: #64748b;
            margin-right: 10px;
        }

        .log-level-info {
            color: #3b82f6;
        }

        .log-level-success {
            color: #10b981;
        }

        .log-level-error {
            color: #ef4444;
        }

        .log-level-warning {
            color: #f59e0b;
        }

        .loading {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #6b7280;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #e5e7eb;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .stats {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .stats h3 {
            color: #0369a1;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .stats p {
            color: #0c4a6e;
            font-size: 14px;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üñºÔ∏è Shopify Image Processor</h1>
            <p>Fast filtering and management for all your 6000+ products</p>
        </div>

        <div class="main-content">
            <div class="sidebar">
                <h2>üîç Search & Filter</h2>
                
                <div class="form-group">
                    <label for="status">Product Status:</label>
                    <select id="status">
                        <option value="any">All Products</option>
                        <option value="active">Active Only</option>
                        <option value="draft">Draft Only</option>
                        <option value="archived">Archived Only</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="metafield">Metafield Key:</label>
                    <select id="metafield">
                        <option value="">Select metafield...</option>
                        <option value="image_needs_attention">image_needs_attention</option>
                        <option value="brand_code">brand_code</option>
                        <option value="supplier">supplier</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="metafieldValue">Metafield Value:</label>
                    <input type="text" id="metafieldValue" placeholder="Enter value (e.g. Y)">
                </div>

                <button class="btn" onclick="searchProducts()" id="searchBtn">üîç Search Products</button>
                <button class="btn btn-secondary" onclick="clearFilters()">üóëÔ∏è Clear Filters</button>

                <div id="statsContainer" style="display: none;">
                    <div class="stats">
                        <h3>üìä Catalog Stats</h3>
                        <p id="totalProducts">Total products: 0</p>
                        <p id="filteredProducts">Filtered: 0</p>
                        <p id="currentPage">Showing: 0</p>
                    </div>
                </div>

                <h2>üöÄ Actions</h2>
                <button class="btn btn-success" onclick="processSelectedProducts()">‚ö° Process Selected</button>
                <button class="btn btn-secondary" onclick="selectAllProducts()">‚úÖ Select All</button>
                <button class="btn btn-secondary" onclick="clearSelection()">‚ùå Clear Selection</button>
            </div>

            <div class="content">
                <div class="pagination-controls">
                    <button class="btn btn-secondary" onclick="prevPage()" id="prevPageBtn" disabled>Previous</button>
                    <span class="pagination-info" id="pageInfo">Page 1 of 1</span>
                    <button class="btn btn-secondary" onclick="nextPage()" id="nextPageBtn" disabled>Next</button>
                </div>

                <div id="loadingIndicator" class="loading" style="display: none;">
                    <div class="spinner"></div>
                    <span>Loading products...</span>
                </div>

                <div id="productsContainer">
                    <p>Click "Search Products" to load products...</p>
                </div>

                <div class="log-container" id="logContainer">
                    <div class="log-entry">
                        <span class="log-timestamp">[00:00:00]</span>
                        <span class="log-level-info">System ready. Click "Search Products" to begin.</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentProducts = [];
        let selectedProducts = new Set();
        let selectedImages = new Set();
        let currentPage = 1;
        let totalPages = 1;
        let totalProducts = 0;
        let totalProductsInCatalog = 0;
        const productsPerPage = 50;

        // Logging system
        function addLog(message, level = 'info') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `
                <span class="log-timestamp">[${timestamp}]</span>
                <span class="log-level-${level}">${message}</span>
            `;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;

            // Keep only last 100 log entries
            const entries = logContainer.querySelectorAll('.log-entry');
            if (entries.length > 100) {
                entries[0].remove();
            }
        }

        // Search products
        async function searchProducts() {
            try {
                setLoading(true);
                addLog('üöÄ Starting product search...', 'info');
                
                const params = new URLSearchParams({
                    status: document.getElementById('status').value,
                    metafield: document.getElementById('metafield').value,
                    metafieldValue: document.getElementById('metafieldValue').value,
                    page: currentPage.toString(),
                    limit: productsPerPage.toString()
                });

                addLog(`üì° Fetching: /api/all-products?${params.toString()}`, 'info');
                const response = await fetch(`/api/all-products?${params.toString()}`);
                const data = await response.json();
                
                if (response.ok) {
                    addLog(`‚úÖ Found ${data.products.length} products (${data.totalProductsInCatalog} total in catalog)`, 'success');
                } else {
                    addLog(`‚ùå Error: ${data.error || 'Unknown error'}`, 'error');
                }
                
                if (data.products !== undefined) {
                    currentProducts = data.products;
                    currentPage = data.page;
                    totalPages = data.totalPages;
                    totalProducts = data.total;
                    totalProductsInCatalog = data.totalProductsInCatalog;
                    
                    updatePaginationControls();
                    displayProducts();
                    updateStats();
                    
                    addLog(`Found ${data.products.length} products (Page ${currentPage} of ${totalPages})`, 'success');
                    addLog(`Total in catalog: ${totalProductsInCatalog} | Filtered: ${totalProducts}`, 'info');
                } else {
                    addLog(`Error: ${data.error || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                addLog(`Error searching products: ${error.message}`, 'error');
            } finally {
                setLoading(false);
            }
        }

        function setLoading(loading) {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const searchBtn = document.getElementById('searchBtn');
            
            if (loading) {
                loadingIndicator.style.display = 'flex';
                searchBtn.disabled = true;
                searchBtn.textContent = 'üîÑ Searching...';
            } else {
                loadingIndicator.style.display = 'none';
                searchBtn.disabled = false;
                searchBtn.textContent = 'üîç Search Products';
            }
        }

        // Display products
        function displayProducts() {
            const container = document.getElementById('productsContainer');
            
            if (currentProducts.length === 0) {
                container.innerHTML = '<p>No products found with current filters.</p>';
                return;
            }

            const html = currentProducts.map(product => {
                const isSelected = selectedProducts.has(product.id);
                const productImages = product.images || [];
                
                return `
                    <div class="product-card ${isSelected ? 'selected' : ''}">
                        <div class="product-info">
                            <div class="product-title">${product.title}</div>
                            <div class="product-meta">
                                ID: ${product.id} | Status: ${product.status} | Type: ${product.product_type || 'N/A'} | Vendor: ${product.vendor || 'N/A'}
                            </div>
                            <div class="product-actions">
                                <button class="btn ${isSelected ? 'btn-secondary' : 'btn'}" onclick="toggleProductSelection(${product.id})">
                                    ${isSelected ? '‚úì Selected' : 'Select'}
                                </button>
                                <button class="btn btn-secondary" onclick="window.open('https://spare-part-mart.myshopify.com/admin/products/${product.id}', '_blank')">
                                    üîó Shopify
                                </button>
                            </div>
                        </div>
                        
                        <div class="product-images">
                            ${productImages.map(image => {
                                const isImageSelected = selectedImages.has(`${product.id}-${image.id}`);
                                return `
                                    <div class="image-item ${isImageSelected ? 'selected' : ''}" onclick="toggleImageSelection(${product.id}, ${image.id})" title="Click to select image">
                                        <img src="${image.src}" alt="${image.alt || 'Product Image'}" loading="lazy">
                                    </div>
                                `;
                            }).join('')}
                            ${productImages.length === 0 ? '<div style="color: #9ca3af; font-size: 12px; padding: 10px;">No images</div>' : ''}
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        // Toggle product selection
        function toggleProductSelection(productId) {
            if (selectedProducts.has(productId)) {
                selectedProducts.delete(productId);
                addLog(`Deselected product ${productId}`, 'info');
            } else {
                selectedProducts.add(productId);
                addLog(`Selected product ${productId}`, 'info');
            }
            displayProducts();
        }

        // Toggle image selection
        function toggleImageSelection(productId, imageId) {
            const key = `${productId}-${imageId}`;
            if (selectedImages.has(key)) {
                selectedImages.delete(key);
                addLog(`Deselected image ${imageId} from product ${productId}`, 'info');
            } else {
                selectedImages.add(key);
                addLog(`Selected image ${imageId} from product ${productId}`, 'info');
            }
            displayProducts();
        }

        // Pagination functions
        function updatePaginationControls() {
            document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
            document.getElementById('prevPageBtn').disabled = currentPage === 1;
            document.getElementById('nextPageBtn').disabled = currentPage === totalPages;
        }

        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                searchProducts();
            }
        }

        function nextPage() {
            if (currentPage < totalPages) {
                currentPage++;
                searchProducts();
            }
        }

        function selectAllProducts() {
            selectedProducts.clear();
            currentProducts.forEach(product => {
                selectedProducts.add(product.id);
            });
            displayProducts();
            addLog(`Selected all ${currentProducts.length} products on current page`, 'success');
        }

        function clearSelection() {
            selectedProducts.clear();
            selectedImages.clear();
            displayProducts();
            addLog('Cleared all selections', 'info');
        }

        // Update stats
        function updateStats() {
            const statsContainer = document.getElementById('statsContainer');
            if (totalProductsInCatalog > 0) {
                statsContainer.style.display = 'block';
                document.getElementById('totalProducts').textContent = `Total products: ${totalProductsInCatalog.toLocaleString()}`;
                document.getElementById('filteredProducts').textContent = `Filtered: ${totalProducts.toLocaleString()}`;
                document.getElementById('currentPage').textContent = `Showing: ${currentProducts.length} on page ${currentPage}`;
            }
        }

        // Clear filters
        function clearFilters() {
            document.getElementById('status').value = 'any';
            document.getElementById('metafield').value = '';
            document.getElementById('metafieldValue').value = '';
            currentPage = 1;
            addLog('Filters cleared', 'info');
        }

        // Process selected products
        function processSelectedProducts() {
            if (selectedProducts.size === 0) {
                addLog('No products selected for processing', 'warning');
                return;
            }
            addLog(`Processing ${selectedProducts.size} selected products...`, 'info');
            addLog('Image processing functionality coming soon...', 'info');
        }

        // Load metafield keys
        async function loadMetafieldKeys() {
            try {
                addLog('üìã Loading metafield keys...', 'info');
                const response = await fetch('/api/metafield-keys');
                const data = await response.json();
                
                if (response.ok) {
                    addLog(`‚úÖ Found ${data.metafieldKeys.length} metafield keys: ${data.metafieldKeys.join(', ')}`, 'success');
                    
                    const metafieldSelect = document.getElementById('metafield');
                    metafieldSelect.innerHTML = '<option value="">Select metafield...</option>';
                    
                    data.metafieldKeys.forEach(key => {
                        const option = document.createElement('option');
                        option.value = key;
                        option.textContent = key;
                        metafieldSelect.appendChild(option);
                    });
                } else {
                    addLog(`‚ùå Error loading metafield keys: ${data.error || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                addLog(`‚ùå Error loading metafield keys: ${error.message}`, 'error');
            }
        }

        // Load product metadata
        async function loadProductMetadata() {
            try {
                addLog('üìä Loading product metadata...', 'info');
                const response = await fetch('/api/product-metadata');
                const data = await response.json();
                
                if (response.ok) {
                    addLog(`‚úÖ Found ${data.productTypes.length} product types and ${data.vendors.length} vendors`, 'success');
                    
                    const typeSelect = document.getElementById('productType');
                    typeSelect.innerHTML = '<option value="">All types</option>';
                    data.productTypes.forEach(type => {
                        const option = document.createElement('option');
                        option.value = type;
                        option.textContent = type;
                        typeSelect.appendChild(option);
                    });
                    
                    const vendorSelect = document.getElementById('vendor');
                    vendorSelect.innerHTML = '<option value="">All vendors</option>';
                    data.vendors.forEach(vendor => {
                        const option = document.createElement('option');
                        option.value = vendor;
                        option.textContent = vendor;
                        vendorSelect.appendChild(option);
                    });
                } else {
                    addLog(`‚ùå Error loading metadata: ${data.error || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                addLog(`‚ùå Error loading metadata: ${error.message}`, 'error');
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            addLog('üöÄ System initialized successfully', 'success');
            addLog('üì¶ Ready to search through your 6000+ product catalog', 'info');
            loadProductMetadata();
            loadMetafieldKeys();
        });
    </script>
</body>
</html>
