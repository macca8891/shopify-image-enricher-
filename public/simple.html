<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopify Image Processor - Simple</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8fafc;
            color: #334155;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .main-content {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
        }
        .sidebar {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            height: fit-content;
        }
        .content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #374151;
        }
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }
        .btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .btn:hover {
            background: #2563eb;
        }
        .btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .btn-secondary {
            background: #6b7280;
        }
        .btn-secondary:hover {
            background: #4b5563;
        }
        .product-grid {
            display: grid;
            gap: 15px;
        }
        .product-card {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            background: white;
        }
        .product-card.selected {
            border-color: #3b82f6;
            background: #f0f9ff;
        }
        .product-title {
            font-size: 16px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 5px;
        }
        .product-meta {
            color: #64748b;
            font-size: 12px;
            margin-bottom: 10px;
        }
        .product-actions {
            display: flex;
            gap: 10px;
        }
        .product-actions .btn {
            margin: 0;
            padding: 5px 10px;
            font-size: 12px;
        }
        .images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 8px;
            margin-top: 10px;
        }
        .image-item {
            width: 80px;
            height: 80px;
            border-radius: 4px;
            border: 2px solid transparent;
            cursor: pointer;
            overflow: hidden;
        }
        .image-item:hover {
            border-color: #3b82f6;
        }
        .image-item.selected {
            border-color: #10b981;
        }
        .image-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .pagination-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin: 20px 0;
            padding: 15px;
            background: #f8fafc;
            border-radius: 8px;
        }
        .pagination-controls .btn {
            margin: 0;
        }
        .log-container {
            background: #1e293b;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 12px;
            line-height: 1.4;
        }
        .log-entry {
            margin-bottom: 3px;
        }
        .log-timestamp {
            color: #64748b;
            margin-right: 10px;
        }
        .log-level-info {
            color: #3b82f6;
        }
        .log-level-success {
            color: #10b981;
        }
        .log-level-warning {
            color: #f59e0b;
        }
        .log-level-error {
            color: #ef4444;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üñºÔ∏è Shopify Image Processor - Simple</h1>
            <p>Fast and simple product filtering and management</p>
        </div>

        <div class="main-content">
            <div class="sidebar">
                <h2>üîç Search & Filter</h2>
                
                <div class="form-group">
                    <label for="status">Product Status:</label>
                    <select id="status">
                        <option value="any">All Products</option>
                        <option value="active">Active Only</option>
                        <option value="draft">Draft Only</option>
                        <option value="archived">Archived Only</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="metafield">Metafield Key:</label>
                    <select id="metafield">
                        <option value="">Select metafield...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="metafieldValue">Metafield Value:</label>
                    <input type="text" id="metafieldValue" placeholder="Enter value to search for...">
                </div>

                <div class="form-group">
                    <label for="productType">Product Type:</label>
                    <select id="productType">
                        <option value="any">All Types</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="vendor">Vendor:</label>
                    <select id="vendor">
                        <option value="any">All Vendors</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="imageCount">Number of Images:</label>
                    <select id="imageCount">
                        <option value="any">Any</option>
                        <option value="0">0 images</option>
                        <option value="1">1 image</option>
                        <option value="2">2 images</option>
                        <option value="3">3 images</option>
                        <option value="4">4 images</option>
                        <option value="5+">5+ images</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="fileType">File Type:</label>
                    <select id="fileType">
                        <option value="any">Any</option>
                        <option value="jpg">JPG</option>
                        <option value="png">PNG</option>
                        <option value="webp">WebP</option>
                        <option value="gif">GIF</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="minWidth">Min Width (px):</label>
                    <input type="number" id="minWidth" placeholder="e.g. 1000">
                </div>

                <div class="form-group">
                    <label for="minHeight">Min Height (px):</label>
                    <input type="number" id="minHeight" placeholder="e.g. 1000">
                </div>

                <button class="btn btn-primary" onclick="searchProducts()">üîç Search Products</button>
                <button class="btn btn-secondary" onclick="clearFilters()">üóëÔ∏è Clear Filters</button>

                <h2>üöÄ Actions</h2>
                <button class="btn btn-success" onclick="processSelectedProducts()">‚ö° Process Selected</button>
                <button class="btn btn-danger" onclick="bulkDeleteSelected()">üóëÔ∏è Delete Selected</button>
            </div>

            <div class="content">
                <div class="pagination-controls">
                    <button class="btn btn-secondary" onclick="prevPage()" id="prevPageBtn" disabled>Previous</button>
                    <span id="pageInfo">Page 1 of 1</span>
                    <button class="btn btn-secondary" onclick="nextPage()" id="nextPageBtn" disabled>Next</button>
                    <button class="btn btn-primary" onclick="selectAllProducts()">Select All Products</button>
                    <button class="btn btn-secondary" onclick="selectPageOnly()">Select Page Only</button>
                </div>

                <div id="productsContainer">
                    <p>Click "Search Products" to load products...</p>
                </div>

                <div class="log-container" id="logContainer">
                    <div class="log-entry">
                        <span class="log-timestamp">[00:00:00]</span>
                        <span class="log-level-info">System ready. Click "Search Products" to begin.</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentProducts = [];
        let selectedProducts = new Set();
        let selectedImages = new Set();
        let currentPage = 1;
        let totalPages = 1;
        let totalProducts = 0;
        const productsPerPage = 250;

        // Logging system
        function addLog(message, level = 'info') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `
                <span class="log-timestamp">[${timestamp}]</span>
                <span class="log-level-${level}">${message}</span>
            `;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // Load metadata on page load
        async function loadMetadata() {
            try {
                addLog('Loading product metadata...', 'info');
                const response = await fetch('/api/product-metadata');
                const data = await response.json();
                
                if (data.productTypes && data.vendors) {
                    const productTypeSelect = document.getElementById('productType');
                    const vendorSelect = document.getElementById('vendor');
                    
                    data.productTypes.forEach(type => {
                        const option = document.createElement('option');
                        option.value = type;
                        option.textContent = type;
                        productTypeSelect.appendChild(option);
                    });
                    
                    data.vendors.forEach(vendor => {
                        const option = document.createElement('option');
                        option.value = vendor;
                        option.textContent = vendor;
                        vendorSelect.appendChild(option);
                    });
                    
                    addLog(`Loaded ${data.productTypes.length} product types and ${data.vendors.length} vendors`, 'success');
                }
            } catch (error) {
                addLog(`Error loading metadata: ${error.message}`, 'error');
            }
        }

        // Load metafield keys
        async function loadMetafieldKeys() {
            try {
                addLog('Loading metafield keys...', 'info');
                const response = await fetch('/api/metafield-keys');
                const data = await response.json();
                
                if (data.metafieldKeys && data.metafieldKeys.length > 0) {
                    const metafieldSelect = document.getElementById('metafield');
                    metafieldSelect.innerHTML = '<option value="">Select metafield...</option>';
                    
                    data.metafieldKeys.forEach(key => {
                        const option = document.createElement('option');
                        option.value = key;
                        option.textContent = key;
                        metafieldSelect.appendChild(option);
                    });
                    
                    addLog(`Loaded ${data.metafieldKeys.length} metafield keys`, 'success');
                } else {
                    addLog('No metafield keys found', 'warning');
                }
            } catch (error) {
                addLog(`Error loading metafield keys: ${error.message}`, 'error');
            }
        }

        // Search products
        async function searchProducts() {
            try {
                addLog('Starting product search...', 'info');
                
                const params = new URLSearchParams({
                    status: document.getElementById('status').value,
                    metafield: document.getElementById('metafield').value,
                    metafieldValue: document.getElementById('metafieldValue').value,
                    type: document.getElementById('productType').value,
                    vendor: document.getElementById('vendor').value,
                    imageCount: document.getElementById('imageCount').value,
                    fileType: document.getElementById('fileType').value,
                    minWidth: document.getElementById('minWidth').value,
                    minHeight: document.getElementById('minHeight').value,
                    page: currentPage.toString(),
                    limit: productsPerPage.toString()
                });

                const response = await fetch(`/api/all-products?${params.toString()}`);
                const data = await response.json();
                
                if (data.products !== undefined) {
                    currentProducts = data.products;
                    currentPage = data.page;
                    totalPages = data.totalPages;
                    totalProducts = data.total;
                    
                    updatePaginationControls();
                    displayProducts();
                    
                    addLog(`Found ${data.products.length} products (Page ${currentPage} of ${totalPages})`, 'success');
                    addLog(`Total products in catalog: ${data.totalProductsInCatalog}`, 'info');
                } else {
                    addLog('No products found or error in response', 'warning');
                }
            } catch (error) {
                addLog(`Error searching products: ${error.message}`, 'error');
            }
        }

        // Display products
        function displayProducts() {
            const container = document.getElementById('productsContainer');
            
            if (currentProducts.length === 0) {
                container.innerHTML = '<p>No products found.</p>';
                return;
            }

            const html = currentProducts.map(product => {
                const isSelected = selectedProducts.has(product.id);
                const productImages = product.images || [];
                
                return `
                    <div class="product-card ${isSelected ? 'selected' : ''}">
                        <div class="product-title">${product.title}</div>
                        <div class="product-meta">
                            ID: ${product.id} | Status: ${product.status} | Type: ${product.product_type || 'N/A'} | Vendor: ${product.vendor || 'N/A'}
                        </div>
                        <div class="product-actions">
                            <button class="btn ${isSelected ? 'btn-secondary' : 'btn-primary'}" onclick="toggleProductSelection(${product.id})">
                                ${isSelected ? '‚úì Selected' : 'Select'}
                            </button>
                            <button class="btn btn-secondary" onclick="window.open('https://spare-part-mart.myshopify.com/admin/products/${product.id}', '_blank')">
                                üîó Shopify
                            </button>
                        </div>
                        
                        <div class="images-grid">
                            ${productImages.map(image => {
                                const isImageSelected = selectedImages.has(`${product.id}-${image.id}`);
                                return `
                                    <div class="image-item ${isImageSelected ? 'selected' : ''}" onclick="toggleImageSelection(${product.id}, ${image.id})">
                                        <img src="${image.src}" alt="${image.alt || 'Product Image'}" loading="lazy">
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        // Toggle product selection
        function toggleProductSelection(productId) {
            if (selectedProducts.has(productId)) {
                selectedProducts.delete(productId);
            } else {
                selectedProducts.add(productId);
            }
            displayProducts();
        }

        // Toggle image selection
        function toggleImageSelection(productId, imageId) {
            const key = `${productId}-${imageId}`;
            if (selectedImages.has(key)) {
                selectedImages.delete(key);
            } else {
                selectedImages.add(key);
            }
            displayProducts();
        }

        // Pagination functions
        function updatePaginationControls() {
            document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
            document.getElementById('prevPageBtn').disabled = currentPage === 1;
            document.getElementById('nextPageBtn').disabled = currentPage === totalPages;
        }

        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                searchProducts();
            }
        }

        function nextPage() {
            if (currentPage < totalPages) {
                currentPage++;
                searchProducts();
            }
        }

        function selectAllProducts() {
            selectedProducts.clear();
            currentProducts.forEach(product => {
                selectedProducts.add(product.id);
            });
            displayProducts();
            addLog(`All ${totalProducts} products selected across all pages`, 'info');
        }

        function selectPageOnly() {
            selectedProducts.clear();
            currentProducts.forEach(product => {
                selectedProducts.add(product.id);
            });
            displayProducts();
            addLog(`All ${currentProducts.length} products on current page selected`, 'info');
        }

        // Clear filters
        function clearFilters() {
            document.getElementById('status').value = 'any';
            document.getElementById('metafield').value = '';
            document.getElementById('metafieldValue').value = '';
            document.getElementById('productType').value = 'any';
            document.getElementById('vendor').value = 'any';
            document.getElementById('imageCount').value = 'any';
            document.getElementById('fileType').value = 'any';
            document.getElementById('minWidth').value = '';
            document.getElementById('minHeight').value = '';
            addLog('Filters cleared', 'info');
        }

        // Process selected products
        async function processSelectedProducts() {
            if (selectedProducts.size === 0) {
                addLog('No products selected for processing', 'warning');
                return;
            }

            try {
                addLog(`Starting bulk processing of ${selectedProducts.size} products...`, 'info');
                addLog('Processing functionality coming soon...', 'info');
            } catch (error) {
                addLog(`Bulk processing error: ${error.message}`, 'error');
            }
        }

        // Bulk delete selected images
        async function bulkDeleteSelected() {
            if (selectedImages.size === 0) {
                addLog('No images selected for deletion', 'warning');
                return;
            }

            try {
                addLog(`Starting bulk deletion of ${selectedImages.size} images...`, 'info');
                addLog('Delete functionality coming soon...', 'info');
            } catch (error) {
                addLog(`Bulk deletion error: ${error.message}`, 'error');
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadMetadata();
            loadMetafieldKeys();
            addLog('System initialized successfully', 'success');
        });
    </script>
</body>
</html>




