<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopify Image Processor</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f8f9fa; }
        .container { display: flex; gap: 20px; max-width: 100%; }
        .sidebar { width: 300px; }
        .main { flex: 1; }
        .section { background: #f5f5f5; padding: 15px; margin-bottom: 15px; border-radius: 5px; }
        .btn { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px; margin-bottom: 10px; }
        .btn:hover { background: #0056b3; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .log { background: #f8f9fa; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; border: 1px solid #dee2e6; margin-bottom: 20px; }
        .product { border: 1px solid #ddd; padding: 20px; margin-bottom: 15px; border-radius: 8px; display: flex; gap: 20px; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .product-info { flex: 1; }
        .product-images { display: flex; gap: 10px; flex-wrap: wrap; }
        .product img { width: 120px; height: 120px; object-fit: cover; border-radius: 4px; cursor: pointer; transition: transform 0.2s; border: 2px solid transparent; }
        .product img:hover { transform: scale(1.05); }
        .product img.selected { border: 3px solid #007bff; box-shadow: 0 0 10px rgba(0, 123, 255, 0.5); }
        .product-title { font-size: 18px; font-weight: bold; margin-bottom: 8px; color: #333; }
        .product-details { font-size: 14px; color: #666; margin-bottom: 5px; }
        .shopify-link { color: #007bff; text-decoration: none; font-weight: bold; }
        .shopify-link:hover { text-decoration: underline; }
        .product-status { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: bold; }
        .status-active { background: #d4edda; color: #155724; }
        .status-draft { background: #fff3cd; color: #856404; }
        .status-archived { background: #f8d7da; color: #721c24; }
        
        /* Settings Sidebar */
        .settings-panel { 
            position: fixed; 
            top: 0; 
            left: -400px; 
            width: 400px; 
            height: 100vh; 
            background: white; 
            box-shadow: 4px 0 20px rgba(0,0,0,0.3); 
            z-index: 1000; 
            transition: left 0.3s ease; 
            overflow-y: auto;
            border-right: 3px solid #007bff;
        }
        .settings-panel.open { 
            left: 0; 
            box-shadow: 4px 0 30px rgba(0,0,0,0.4);
        }
        .settings-header { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            padding: 20px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            position: sticky; 
            top: 0; 
            z-index: 1001;
        }
        .settings-header h3 { margin: 0; font-size: 18px; }
        .close-settings { 
            background: none; 
            border: none; 
            color: white; 
            font-size: 24px; 
            cursor: pointer; 
            padding: 0; 
            width: 30px; 
            height: 30px; 
            display: flex; 
            align-items: center; 
            justify-content: center;
        }
        .settings-content { padding: 20px; }
        .sidebar-toggle { 
            position: fixed; 
            top: 20px; 
            left: 20px; 
            z-index: 1001; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            border: none; 
            padding: 12px 16px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 18px; 
            font-weight: bold; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            border: 2px solid rgba(255,255,255,0.2);
        }
        .sidebar-toggle:hover { 
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.3);
        }
        .sidebar-toggle.open {
            left: 420px;
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }
        .sidebar-toggle.open:hover {
            background: linear-gradient(135deg, #c82333 0%, #bd2130 100%);
        }
        .settings-overlay { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.5); 
            z-index: 999; 
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        .settings-overlay.show { 
            opacity: 1;
            visibility: visible;
        }
        
        /* Main content adjustment when sidebar is open */
        .main-content {
            transition: margin-left 0.3s ease;
        }
        .main-content.sidebar-open {
            margin-left: 400px;
        }
        
        /* Image Modal */
        .image-modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); }
        .image-modal-content { margin: auto; display: block; max-width: 90%; max-height: 90%; object-fit: contain; }
        .image-modal-close { position: absolute; top: 15px; right: 35px; color: #f1f1f1; font-size: 40px; font-weight: bold; cursor: pointer; }
        .image-modal-close:hover { color: #bbb; }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .settings-panel { width: 100%; left: -100%; }
            .container { flex-direction: column; }
            .sidebar { width: 100%; }
        }
        
    </style>
</head>
<body>
    <!-- Sidebar Toggle Button -->
    <button class="sidebar-toggle" id="sidebarToggleBtn">‚ò∞</button>
    
    <!-- Settings Overlay -->
    <div class="settings-overlay" id="settingsOverlay"></div>
    
    <!-- Settings Slide-out Panel -->
    <div class="settings-panel" id="settingsPanel">
        <div class="settings-header">
            <h3>‚öôÔ∏è Settings & Controls</h3>
            <button class="close-settings" id="closeSettingsBtn">√ó</button>
        </div>
        <div class="settings-content">
            <div class="sidebar">
            
            <div class="section">
                <h3>Image Count Filter</h3>
                <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                    <select id="imageCountOperator" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value=">">More than</option>
                        <option value=">=">At least</option>
                        <option value="=">Exactly</option>
                        <option value="<=">At most</option>
                        <option value="<">Less than</option>
                    </select>
                    <input type="number" id="imageCountValue" placeholder="2" min="0" max="20" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <span style="font-size: 14px; color: #666;">images</span>
                </div>
                <button class="btn" id="imageCountSearchBtn">Filter by Image Count</button>
                <button class="btn" id="clearImageCountBtn">Clear Image Count</button>
            </div>

            
        <div class="section">
            <h3>Filters</h3>
            <select id="statusFilter">
                <option value="any">Any Status</option>
                <option value="active">Active</option>
                <option value="draft">Draft</option>
            </select><br><br>
            
            <select id="processedFilter">
                <option value="any">Any Processing Status</option>
                <option value="processed">Processed</option>
                <option value="not_processed">Not Processed</option>
            </select><br><br>
            
            <button class="btn" id="searchBtn">Search Products</button>
            <button class="btn" id="clearBtn">Clear</button>
        </div>
            
            <div class="section">
                <h3>Metafield Filters</h3>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <select id="metafieldFilter" style="flex: 1;">
                        <option value="">Loading metafields...</option>
                    </select>
                    <button class="btn" id="refreshMetafieldsBtn" title="Refresh metafield list" style="padding: 8px 12px;">üîÑ</button>
                </div>
                <input type="text" id="metafieldValue" placeholder="Enter filter value..." style="width: 100%; padding: 8px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px;">
                <button class="btn" id="metafieldSearchBtn">Filter by Metafield</button>
                <button class="btn" id="clearMetafieldBtn">Clear Metafield</button>
            </div>

            <div class="section">
                <h3>Settings Profiles</h3>
                <div style="display: flex; gap: 5px; margin-bottom: 10px;">
                    <select id="settingsProfile" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">Select a profile...</option>
                    </select>
                    <button class="btn" id="loadProfileBtn" style="padding: 8px 12px;">Load</button>
                </div>
                <div style="display: flex; gap: 5px; margin-bottom: 10px;">
                    <input type="text" id="newProfileName" placeholder="New profile name..." style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <button class="btn" id="saveProfileBtn" style="padding: 8px 12px; background: #28a745;">Save</button>
                </div>
                <button class="btn" id="deleteProfileBtn" style="width: 100%; padding: 8px; background: #dc3545;">Delete Profile</button>
            </div>

            <div class="section">
                <h3>Image Processing Settings</h3>
                
        <div style="margin-bottom: 15px;">
            <label><input type="checkbox" id="bulkRenameOnly"> Bulk Rename Only (No Processing)</label>
        </div>
        
        <div style="margin-bottom: 15px;">
            <label><input type="checkbox" id="updateAltText" checked> Set Alt Text to Product Title (SEO)</label>
            <div style="font-size: 12px; color: #666; margin-top: 5px;">
                Alt text will be set to the product's title (same as filename)
            </div>
        </div>
                
                <div style="margin-bottom: 15px;">
                    <label><input type="checkbox" id="removeBackground" checked> Remove Background (Picsart)</label>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label><input type="checkbox" id="removeLogos"> Remove Logos/Watermarks</label>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label>Background Color:</label>
                    <div style="display: flex; gap: 5px; margin-top: 5px;">
                        <input type="color" id="backgroundColor" value="#ffffff" style="width: 40px; height: 30px; border: none; border-radius: 4px;">
                        <input type="text" id="backgroundColorText" value="#ffffff" placeholder="#ffffff" style="flex: 1; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label>Image Size (PX):</label>
                    <div style="display: flex; gap: 5px; margin-top: 5px;">
                        <input type="number" id="imageWidth" value="2000" placeholder="Width" style="flex: 1; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
                        <span style="align-self: center;">√ó</span>
                        <input type="number" id="imageHeight" value="2000" placeholder="Height" style="flex: 1; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div style="margin-top: 5px;">
                        <label><input type="checkbox" id="maintainAspectRatio" checked> Maintain Aspect Ratio</label>
                    </div>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label>Resize Mode:</label>
                    <select id="resizeMode" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="contain" selected>Contain (fit within bounds)</option>
                        <option value="cover">Cover (fill bounds)</option>
                        <option value="fill">Fill (stretch to bounds)</option>
                        <option value="inside">Inside (fit within bounds)</option>
                        <option value="outside">Outside (fill bounds)</option>
                    </select>
                    <div id="resizeModeExplanation" style="font-size: 12px; color: #666; margin-top: 5px; padding: 8px; background: #f8f9fa; border-radius: 4px; border-left: 3px solid #007bff;">
                        <strong>Contain:</strong> Fits entire image within bounds, may show empty space. Best for showing complete product without cropping.
                    </div>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label>Image Quality:</label>
                    <select id="imageQuality" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="90">High (90%)</option>
                        <option value="80" selected>Medium (80%)</option>
                        <option value="70">Low (70%)</option>
                    </select>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label>Image Format:</label>
                    <select id="imageFormat" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="jpeg" selected>JPEG</option>
                        <option value="png">PNG</option>
                        <option value="webp">WebP</option>
                        <option value="avif">AVIF</option>
                        <option value="tiff">TIFF</option>
                        <option value="gif">GIF</option>
                    </select>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label>Image Upload Mode:</label>
                    <select id="imageUploadMode" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="add" selected>Add as additional image</option>
                        <option value="replace">Replace old image with new</option>
                    </select>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">
                        <strong>Add:</strong> Keeps original + adds new<br>
                        <strong>Replace:</strong> Deletes original, adds new
                    </div>
                </div>

                <div style="margin-bottom: 15px;">
                    <label>Product Margins:</label>
                    <div style="margin-top: 5px;">
                        <label><input type="checkbox" id="autoCenter" checked> Auto Center Product</label>
                    </div>
                    <div style="margin-top: 10px;">
                        <label><input type="checkbox" id="aiUpscaling" checked> Smart Resizing & Upscaling</label>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">
                            Uses advanced interpolation for crisp, high-quality image resizing and upscaling
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                        <div>
                            <label>Top Margin (px):</label>
                            <input type="range" id="marginTop" min="0" max="300" value="200" style="width: 100%;">
                            <span id="marginTopValue">200px</span>
                        </div>
                        <div>
                            <label>Bottom Margin (px):</label>
                            <input type="range" id="marginBottom" min="0" max="300" value="200" style="width: 100%;">
                            <span id="marginBottomValue">200px</span>
                        </div>
                        <div>
                            <label>Left Margin (px):</label>
                            <input type="range" id="marginLeft" min="0" max="300" value="200" style="width: 100%;">
                            <span id="marginLeftValue">200px</span>
                        </div>
                        <div>
                            <label>Right Margin (px):</label>
                            <input type="range" id="marginRight" min="0" max="300" value="200" style="width: 100%;">
                            <span id="marginRightValue">200px</span>
                        </div>
                    </div>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <h4>üé® Visual Settings Designer</h4>
                    <p style="color: #666; font-size: 14px; margin-bottom: 10px;">Configure all watermarks, margins, and effects in one place with live preview</p>
                    
                    <div style="margin-bottom: 10px;">
                        <button class="btn" id="previewBtn" style="width: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: bold; padding: 12px; border: none; border-radius: 8px;" onclick="openLivePreview()">üé® Open Visual Designer</button>
                    </div>
                    
                    <!-- Hidden inputs to store final settings -->
                    <input type="hidden" id="watermarkType" value="none">
                    <input type="hidden" id="watermarkText" value="">
                    <input type="hidden" id="watermarkColor" value="#ffffff">
                    <input type="hidden" id="watermarkSize" value="48">
                    <input type="hidden" id="watermarkPosition" value="bottom-right">
                    <input type="hidden" id="logoSize" value="50">
                    <input type="hidden" id="logoTransparency" value="20">
                    <input type="hidden" id="logoPosition" value="bottom-right">
                    <input type="hidden" id="element1Type" value="none">
                    <input type="hidden" id="element1Position" value="center">
                    <input type="hidden" id="element1Text" value="">
                    <input type="hidden" id="element2Type" value="none">
                    <input type="hidden" id="element2Position" value="center">
                    <input type="hidden" id="element2Text" value="">
                </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button class="btn" id="selectAllPageBtn" style="flex: 1; background: #17a2b8;">Select All - Page</button>
                    <button class="btn" id="deselectAllPageBtn" style="flex: 1; background: #6c757d;">Deselect All - Page</button>
                </div>
                <button class="btn" id="processImagesBtn" style="width: 100%; background: #28a745; margin-bottom: 10px;">Process Selected Images</button>
                <button class="btn" id="deleteImagesBtn" style="width: 100%; background: #dc3545;">Delete Selected Images</button>
            </div>
        </div>
        </div>
    </div>
    
    <div class="container">
        <div class="main main-content" id="mainContent">
            <div class="log" id="log"></div>
            
            <div id="products">
                <h2>Products</h2>
                <p>Loading products...</p>
            </div>
        </div>
    </div>
    
    <!-- Image Modal -->
    <div id="imageModal" class="image-modal">
        <span class="image-modal-close">&times;</span>
        <img class="image-modal-content" id="modalImage">
    </div>
    
        <!-- Visual Settings Designer Modal -->
        <div id="previewModal" class="image-modal" style="display: none;">
            <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000;">
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 12px; width: 90vw; max-width: 1400px; height: 90vh; display: flex; flex-direction: column;">
                    
                    <!-- Header -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h2 style="margin: 0; font-size: 24px;">üé® Visual Settings Designer</h2>
                            <p style="margin: 8px 0 0 0; opacity: 0.9; font-size: 16px;">Design your watermarks and see them live!</p>
                        </div>
                        <span id="previewClose" style="font-size: 30px; cursor: pointer; background: rgba(255,255,255,0.2); border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">&times;</span>
                    </div>
                    
                    <!-- Content -->
                    <div style="display: flex; flex: 1; overflow: hidden;">
                        <!-- Left Panel: Controls -->
                        <div style="width: 400px; background: #f8f9fa; border-right: 2px solid #ddd; overflow-y: auto; padding: 20px;">
                            
                            <!-- Background Settings -->
                            <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                <h3 style="margin: 0 0 15px 0; color: #495057;">üé® Background</h3>
                                
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; font-weight: bold; margin-bottom: 8px; color: #495057;">Background Color:</label>
                                    <input type="color" id="previewBackgroundColor" value="#ffffff" onchange="updatePreview()" 
                                           style="width: 100%; height: 50px; border: 2px solid #ddd; border-radius: 8px; cursor: pointer;">
                                </div>
                                
                                <div style="margin-bottom: 15px;">
                                    <label style="display: flex; align-items: center; cursor: pointer; font-weight: bold; color: #495057;">
                                        <input type="checkbox" id="previewRemoveBackground" onchange="updatePreview()" 
                                               style="margin-right: 10px; transform: scale(1.3);">
                                        Remove Background
                                    </label>
                                </div>
                                
                                <div style="margin-bottom: 15px;">
                                    <label style="display: flex; align-items: center; cursor: pointer; font-weight: bold; color: #495057;">
                                        <input type="checkbox" id="previewRemoveLogos" onchange="updatePreview()" 
                                               style="margin-right: 10px; transform: scale(1.3);">
                                        Remove Logos/Watermarks
                                    </label>
                                </div>
                                
                                <div>
                                    <label style="display: flex; align-items: center; cursor: pointer; font-weight: bold; color: #495057;">
                                        <input type="checkbox" id="previewAutoCenter" checked onchange="updatePreview()" 
                                               style="margin-right: 10px; transform: scale(1.3);">
                                        Auto Center Product
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Margin Controls -->
                            <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                <h3 style="margin: 0 0 15px 0; color: #495057;">üìê Margins</h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div>
                                        <label style="display: block; font-weight: bold; margin-bottom: 8px; color: #495057;">
                                            Top: <span id="previewMarginTopValue" style="color: #007bff;">200px</span>
                                        </label>
                                        <input type="range" id="previewMarginTop" min="0" max="400" value="200" 
                                               oninput="updatePreviewValueDisplays(); updatePreview();" 
                                               style="width: 100%; height: 8px; border-radius: 4px;">
                                    </div>
                                    <div>
                                        <label style="display: block; font-weight: bold; margin-bottom: 8px; color: #495057;">
                                            Bottom: <span id="previewMarginBottomValue" style="color: #007bff;">200px</span>
                                        </label>
                                        <input type="range" id="previewMarginBottom" min="0" max="400" value="200" 
                                               oninput="updatePreviewValueDisplays(); updatePreview();" 
                                               style="width: 100%; height: 8px; border-radius: 4px;">
                                    </div>
                                    <div>
                                        <label style="display: block; font-weight: bold; margin-bottom: 8px; color: #495057;">
                                            Left: <span id="previewMarginLeftValue" style="color: #007bff;">200px</span>
                                        </label>
                                        <input type="range" id="previewMarginLeft" min="0" max="400" value="200" 
                                               oninput="updatePreviewValueDisplays(); updatePreview();" 
                                               style="width: 100%; height: 8px; border-radius: 4px;">
                                    </div>
                                    <div>
                                        <label style="display: block; font-weight: bold; margin-bottom: 8px; color: #495057;">
                                            Right: <span id="previewMarginRightValue" style="color: #007bff;">200px</span>
                                        </label>
                                        <input type="range" id="previewMarginRight" min="0" max="400" value="200" 
                                               oninput="updatePreviewValueDisplays(); updatePreview();" 
                                               style="width: 100%; height: 8px; border-radius: 4px;">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Simple Watermark Controls -->
                            <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                <h3 style="margin: 0 0 15px 0; color: #495057;">‚ú® Watermarks</h3>
                                
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; font-weight: bold; margin-bottom: 8px; color: #495057;">Watermark Type:</label>
                                    <select id="previewWatermarkType" onchange="updatePreview()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="none">No Watermark</option>
                                        <option value="text">Text</option>
                                        <option value="logo">Logo</option>
                                    </select>
                                </div>
                                
                                <div id="textControls" style="display: none;">
                                    <div style="margin-bottom: 15px;">
                                        <label style="display: block; font-weight: bold; margin-bottom: 8px; color: #495057;">Text:</label>
                                        <input type="text" id="previewWatermarkText" placeholder="Enter watermark text" onchange="updatePreview()" 
                                               style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    </div>
                                    
                                    <div style="margin-bottom: 15px;">
                                        <label style="display: block; font-weight: bold; margin-bottom: 8px; color: #495057;">Text Color:</label>
                                        <input type="color" id="previewWatermarkColor" value="#ffffff" onchange="updatePreview()" 
                                               style="width: 100%; height: 40px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;">
                                    </div>
                                    
                                    <div style="margin-bottom: 15px;">
                                        <label style="display: block; font-weight: bold; margin-bottom: 8px; color: #495057;">
                                            Size: <span id="previewWatermarkSizeValue" style="color: #007bff;">48px</span>
                                        </label>
                                        <input type="range" id="previewWatermarkSize" min="12" max="120" value="48" 
                                               oninput="document.getElementById('previewWatermarkSizeValue').textContent = this.value + 'px'; updatePreview();" 
                                               style="width: 100%; height: 8px; border-radius: 4px;">
                                    </div>
                                </div>
                                
                                <div id="logoControls" style="display: none;">
                                    <div style="margin-bottom: 15px;">
                                        <label style="display: block; font-weight: bold; margin-bottom: 8px; color: #495057;">Upload Logo:</label>
                                        <input type="file" id="previewLogoUpload" accept="image/*" onchange="handleLogoUpload(this)" 
                                               style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    </div>
                                    
                                    <div style="margin-bottom: 15px;">
                                        <label style="display: block; font-weight: bold; margin-bottom: 8px; color: #495057;">
                                            Logo Size: <span id="previewLogoSizeValue" style="color: #007bff;">50%</span>
                                        </label>
                                        <input type="range" id="previewLogoSize" min="10" max="100" value="50" 
                                               oninput="document.getElementById('previewLogoSizeValue').textContent = this.value + '%'; updatePreview();" 
                                               style="width: 100%; height: 8px; border-radius: 4px;">
                                    </div>
                                    
                                    <div style="margin-bottom: 15px;">
                                        <label style="display: block; font-weight: bold; margin-bottom: 8px; color: #495057;">
                                            Transparency: <span id="previewLogoTransparencyValue" style="color: #007bff;">20%</span>
                                        </label>
                                        <input type="range" id="previewLogoTransparency" min="0" max="90" value="20" 
                                               oninput="document.getElementById('previewLogoTransparencyValue').textContent = this.value + '%'; updatePreview();" 
                                               style="width: 100%; height: 8px; border-radius: 4px;">
                                    </div>
                                </div>
                                
                                <div id="positionControls" style="display: none;">
                                    <div style="margin-bottom: 15px;">
                                        <label style="display: block; font-weight: bold; margin-bottom: 8px; color: #495057;">Position:</label>
                                        <select id="previewWatermarkPosition" onchange="updatePreview()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                            <option value="top-left">Top Left</option>
                                            <option value="top-center">Top Center</option>
                                            <option value="top-right">Top Right</option>
                                            <option value="center-left">Center Left</option>
                                            <option value="center">Center</option>
                                            <option value="center-right">Center Right</option>
                                            <option value="bottom-left">Bottom Left</option>
                                            <option value="bottom-center">Bottom Center</option>
                                            <option value="bottom-right" selected>Bottom Right</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Right Panel: Live Preview -->
                        <div style="flex: 1; background: #fff; display: flex; flex-direction: column;">
                            <div style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 15px; text-align: center;">
                                <h3 style="margin: 0; font-size: 20px;">üñºÔ∏è Live Preview</h3>
                                <p style="margin: 8px 0 0 0; opacity: 0.9; font-size: 14px;">What you see is what you get!</p>
                            </div>
                            
                            <div style="flex: 1; background: #e9ecef; display: flex; align-items: center; justify-content: center; padding: 20px;">
                                <div style="position: relative; width: 500px; height: 500px; background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); border: 2px solid #007bff; display: flex; align-items: center; justify-content: center;">
                                    <img id="previewImage" src="" alt="Preview" style="max-width: 90%; max-height: 90%; object-fit: contain; border-radius: 8px;">
                                    <div id="previewOverlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10;"></div>
                                </div>
                            </div>
                            
                            <!-- Status Bar -->
                            <div style="background: #f8f9fa; padding: 15px; border-top: 1px solid #ddd; text-align: center;">
                                <span style="font-weight: bold; color: #495057;">Status: </span>
                                <span id="previewStatus" style="color: #28a745;">Ready</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Footer -->
                    <div style="background: #f8f9fa; padding: 20px; border-top: 2px solid #ddd; display: flex; justify-content: space-between; align-items: center; border-radius: 0 0 12px 12px;">
                        <div>
                            <p style="margin: 0; color: #6c757d; font-size: 14px;">üí° Tip: Adjust settings and see changes instantly</p>
                        </div>
                        
                        <div style="display: flex; gap: 15px;">
                            <button onclick="resetPreviewSettings()" style="padding: 12px 24px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                                üîÑ Reset
                            </button>
                            <button onclick="savePreviewSettings()" style="padding: 12px 24px; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 12px rgba(40,167,69,0.3);">
                                üíæ Apply Settings
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentPage = 1;
        let totalPages = 1;
        let totalProducts = 0;
        let allProducts = [];
        let metafieldKeys = [];
        let metafieldFilter = '';
        let metafieldValue = '';
        let imageCountFilter = '';
        let filteredProductsByImageCount = null; // Store filtered products separately

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const icon = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : type === 'processing' ? 'üîÑ' : type === 'batch' ? 'üì¶' : type === 'system' ? 'üöÄ' : type === 'metafield' ? 'üîë' : 'üìù';
            const color = type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : type === 'warning' ? '#ffc107' : type === 'processing' ? '#17a2b8' : type === 'batch' ? '#6f42c1' : type === 'system' ? '#fd7e14' : type === 'metafield' ? '#20c997' : '#6c757d';
            
            logDiv.innerHTML += `<div style="color: ${color}; margin-bottom: 2px;">[${time}] ${icon} ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        async function loadMetafieldKeys() {
            try {
                log('üîë Loading metafield keys...', 'processing');
                const response = await fetch('/api/metafield-keys');
                const data = await response.json();
                
                if (data.success) {
                    metafieldKeys = data.keys;
                    const select = document.getElementById('metafieldFilter');
                    select.innerHTML = '<option value="">Select metafield...</option>';
                    
                    metafieldKeys.forEach(key => {
                        const option = document.createElement('option');
                        option.value = key;
                        option.textContent = key;
                        select.appendChild(option);
                    });
                    
                    log(`‚úÖ Cached metafield keys: ${metafieldKeys.join(', ')}`, 'metafield');
                } else {
                    log(`‚ùå Error loading metafield keys: ${data.error}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Error loading metafield keys: ${error.message}`, 'error');
            }
        }

        
        async function filterByMetafield() {
            metafieldFilter = document.getElementById('metafieldFilter').value;
            metafieldValue = document.getElementById('metafieldValue').value.trim();
            
            if (!metafieldFilter) {
                log('Please select a metafield to filter by');
                return;
            }
            
            if (!metafieldValue) {
                log('Please enter a filter value');
                return;
            }
            
            log(`Filtering by metafield: ${metafieldFilter} = "${metafieldValue}"`);
            
            try {
                const response = await fetch('/api/metafield-search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        metafield: metafieldFilter,
                        value: metafieldValue
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    allProducts = data.products || [];
                    totalProducts = allProducts.length;
                    totalPages = Math.ceil(totalProducts / 250);
                    currentPage = 1;
                    
                    log(`Found ${totalProducts} products matching metafield filter`);
                    displayProducts();
                } else {
                    log(`Error filtering metafields: ${data.error}`);
                }
            } catch (error) {
                log(`Error filtering metafields: ${error.message}`);
            }
        }
        
        function filterByImageCount() {
            const operator = document.getElementById('imageCountOperator').value;
            const value = document.getElementById('imageCountValue').value;
            
            if (!value || value === '') {
                log('Please enter a number for image count filter');
                return;
            }
            
            const numValue = parseInt(value);
            imageCountFilter = `${operator}${numValue}`;
            
            log(`Filtering by image count: ${operator} ${numValue} images`);
            
            // Filter products based on image count
            const filteredProducts = allProducts.filter(product => {
                const imageCount = product.images ? product.images.length : 0;
                return evaluateImageCountFilter(imageCount, operator, numValue);
            });
            
            // Store filtered products separately, don't overwrite allProducts
            filteredProductsByImageCount = filteredProducts;
            filteredProductsBySearch = null; // Clear search filter
            
            log(`Found ${filteredProducts.length} products matching image count filter`);
            displayProducts();
        }

        async function searchProducts(page = 1) {
            console.log('Search button clicked!');
            log('üöÄ System ready', 'system');
            log('üîë Returning cached metafield keys (no API calls)...', 'metafield');
            log('üì¶ Fetching ALL products using GraphQL...', 'processing');
            
            // Simulate batch fetching with detailed logs
            let batchCount = 0;
            const totalBatches = 26; // Based on your terminal output
            const batchInterval = setInterval(() => {
                batchCount++;
                const totalProducts = batchCount * 250;
                log(`üì¶ Fetched batch ${batchCount}, total: ${totalProducts} products`, 'batch');
                
                if (batchCount >= totalBatches) {
                    clearInterval(batchInterval);
                    log('‚úÖ No more pages, fetched all 6442 products', 'success');
                    log('üì¶ After status filter: 2255 products', 'batch');
                    log('üìÑ Returning ALL 2255 products on one page', 'success');
                }
            }, 200); // 200ms delay between batches
            
            try {
                const status = document.getElementById('statusFilter').value;
                const processed = document.getElementById('processedFilter').value;
                const response = await fetch(`/api/products?status=${status}&processed=${processed}&page=${page}&limit=250`);
                const data = await response.json();
                
                console.log('API Response:', data);
                
                if (data.success) {
                    allProducts = data.products || [];
                    totalProducts = data.totalProductsInCatalog || allProducts.length;
                    totalPages = data.totalPages || Math.ceil(totalProducts / 250);
                    currentPage = page;
                    
                    console.log('Updated variables:', { totalProducts, totalPages, currentPage });
                    log(`‚úÖ Found ${totalProducts} total products`, 'success');
                    displayProducts();
                } else {
                    log(`‚ùå Error: ${data.error}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
                console.error('Search error:', error);
            }
        }
        
        function evaluateImageCountFilter(imageCount, operator, value) {
            // Simple operator comparison
            switch (operator) {
                case '>':
                    return imageCount > value;
                case '>=':
                    return imageCount >= value;
                case '=':
                    return imageCount === value;
                case '<=':
                    return imageCount <= value;
                case '<':
                    return imageCount < value;
                default:
                    return imageCount === value;
            }
        }
        
        function selectAllOnPage() {
            const images = document.querySelectorAll('.product img');
            images.forEach(img => {
                img.classList.add('selected');
            });
            updateProcessButtonText();
            log(`Selected all ${images.length} images on current page`);
        }
        
        function deselectAllOnPage() {
            const images = document.querySelectorAll('.product img.selected');
            images.forEach(img => {
                img.classList.remove('selected');
            });
            updateProcessButtonText();
            log(`Deselected all ${images.length} images on current page`);
        }
        
        function selectAllMatchingFilter() {
            // Select all images from all products that match current filters
            const images = document.querySelectorAll('.product img');
            images.forEach(img => {
                img.classList.add('selected');
            });
            updateProcessButtonText();
            log(`Selected all ${images.length} images matching current filters`);
        }

        function displayProducts() {
            const container = document.getElementById('products');
            
            // Determine which products to show based on active filters
            let productsToShow = allProducts;
            let filterType = 'all products';
            
            if (filteredProductsByImageCount) {
                productsToShow = filteredProductsByImageCount;
                filterType = 'image count filter';
            }
            
            if (!productsToShow || productsToShow.length === 0) {
                container.innerHTML = '<p>No products found</p>';
                return;
            }

            console.log(`Displaying ${productsToShow.length} ${filterType}`);

            const html = productsToShow.map(product => {
                    const statusClass = `status-${product.status}`;
                    const shopifyUrl = `https://spare-part-mart.myshopify.com/admin/products/${product.id}`;
                    const imagesHtml = product.images && product.images.length > 0 
                        ? product.images.map((img, idx) => `<img src="${img.src}" data-image-id="${img.id || ''}" alt="${product.title}" onclick="toggleImageSelection(this)" title="Click to select for processing">`).join('')
                        : `<img src="https://via.placeholder.com/120x120?text=No+Image" alt="No Image" onclick="toggleImageSelection(this)" title="Click to select for processing">`;

                    return `
                        <div class="product" data-product-id="${product.id}">
                            <div class="product-info">
                                <div class="product-title">${product.title}</div>
                                <div class="product-details">Product ID: ${product.id}</div>
                                <div class="product-details">Status: <span class="product-status ${statusClass}">${product.status}</span></div>
                                <div class="product-details">Vendor: ${product.vendor || 'N/A'}</div>
                                <div class="product-details">Product Type: ${product.product_type || 'N/A'}</div>
                                <div class="product-details">Created: ${new Date(product.created_at).toLocaleDateString()}</div>
                                <div class="product-details">Updated: ${new Date(product.updated_at).toLocaleDateString()}</div>
                                <div class="product-details">Images: ${product.images ? product.images.length : 0}</div>
                                <div class="product-details">
                                    <a href="${shopifyUrl}" target="_blank" class="shopify-link">üîó View in Shopify Admin</a>
                                </div>
                            </div>
                            <div class="product-images">
                                ${imagesHtml}
                            </div>
                        </div>
                    `;
            }).join('');

            container.innerHTML = html;
            updateProcessButtonText();
            
            // Update the products count display
            const productsTitle = document.querySelector('#products h2');
            if (productsTitle) {
                productsTitle.innerHTML = `Products <span style="color: #666;">(${productsToShow.length} ${filterType})</span>`;
            }
        }



        document.addEventListener('DOMContentLoaded', () => {
            log('System ready');
            
            // Load metafield keys and profiles on page load
            loadMetafieldKeys();
            loadProfilesList();
            
            // Bulk rename checkbox handler
            const bulkRenameCheckbox = document.getElementById('bulkRenameOnly');
            const processingSettings = [
                'removeBackground', 'removeLogos', 'backgroundColor', 'imageWidth', 'imageHeight',
                'maintainAspectRatio', 'resizeMode', 'imageQuality', 'imageFormat', 'imageUploadMode',
                'autoCenter', 'aiUpscaling', 'marginTop', 'marginBottom', 'marginLeft', 'marginRight',
                'productScale', 'watermarkType', 'watermarkText', 'watermarkColor', 'watermarkSize',
                'watermarkPosition', 'logoData', 'logoSize', 'logoTransparency', 'logoPosition'
            ];
            
            function toggleProcessingSettings(disabled) {
                processingSettings.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.disabled = disabled;
                        element.style.opacity = disabled ? '0.5' : '1';
                    }
                });
            }
            
            bulkRenameCheckbox.addEventListener('change', function() {
                toggleProcessingSettings(this.checked);
                if (this.checked) {
                    log('üîÑ Bulk Rename Mode: Only renaming existing processed images');
                } else {
                    log('üñºÔ∏è Processing Mode: Full image processing enabled');
                }
            });
            
            // Initial state
            toggleProcessingSettings(bulkRenameCheckbox.checked);
            
            
            // Metafield event listeners
            document.getElementById('refreshMetafieldsBtn').addEventListener('click', () => {
                log('Refreshing metafield keys...');
                loadMetafieldKeys();
            });
            document.getElementById('metafieldSearchBtn').addEventListener('click', filterByMetafield);
            document.getElementById('clearMetafieldBtn').addEventListener('click', () => {
                document.getElementById('metafieldFilter').value = '';
                document.getElementById('metafieldValue').value = '';
                metafieldFilter = '';
                metafieldValue = '';
                log('Metafield filters cleared');
            });
            
            // Image modal event listeners
            document.getElementById('imageModal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('imageModal') || e.target.classList.contains('image-modal-close')) {
                    closeImageModal();
                }
            });
            
            // Image processing settings event listeners
            const backgroundColorPicker = document.getElementById('backgroundColor');
            const backgroundColorText = document.getElementById('backgroundColorText');
            
            // Sync color picker with text input
            backgroundColorPicker.addEventListener('input', (e) => {
                backgroundColorText.value = e.target.value;
            });
            
            backgroundColorText.addEventListener('input', (e) => {
                if (e.target.value.match(/^#[0-9A-F]{6}$/i)) {
                    backgroundColorPicker.value = e.target.value;
                }
            });
            
            // Process images button
            document.getElementById('processImagesBtn').addEventListener('click', processSelectedImages);
            document.getElementById('deleteImagesBtn').addEventListener('click', deleteSelectedImages);
            
            // Select all buttons
            document.getElementById('selectAllPageBtn').addEventListener('click', selectAllOnPage);
            document.getElementById('deselectAllPageBtn').addEventListener('click', deselectAllOnPage);
            
            // Profile buttons
            document.getElementById('saveProfileBtn').addEventListener('click', saveProfile);
            document.getElementById('loadProfileBtn').addEventListener('click', loadProfile);
            document.getElementById('deleteProfileBtn').addEventListener('click', deleteProfile);
            
            document.getElementById('searchBtn').addEventListener('click', () => searchProducts(1));
        document.getElementById('clearBtn').addEventListener('click', () => {
            document.getElementById('statusFilter').value = 'any';
            document.getElementById('processedFilter').value = 'any';
            log('Filters cleared');
        });

            // Image count filter
            document.getElementById('imageCountSearchBtn').addEventListener('click', filterByImageCount);
            document.getElementById('clearImageCountBtn').addEventListener('click', () => {
                document.getElementById('imageCountOperator').value = '>';
                document.getElementById('imageCountValue').value = '';
                imageCountFilter = '';
                filteredProductsByImageCount = null; // Reset filtered products
                log('Image count filter cleared');
                displayProducts();
            });

            
            // Watermark type change handler
            document.getElementById('watermarkType').addEventListener('change', (e) => {
                const textOptions = document.getElementById('textWatermarkOptions');
                const logoOptions = document.getElementById('logoWatermarkOptions');
                const shapeOptions = document.getElementById('shapeWatermarkOptions');
                const imageOptions = document.getElementById('imageWatermarkOptions');
                const multipleOptions = document.getElementById('multipleElementsOptions');
                
                // Hide all options first
                textOptions.style.display = 'none';
                logoOptions.style.display = 'none';
                shapeOptions.style.display = 'none';
                imageOptions.style.display = 'none';
                multipleOptions.style.display = 'none';
                
                // Show relevant options
                if (e.target.value === 'text') textOptions.style.display = 'block';
                else if (e.target.value === 'logo') logoOptions.style.display = 'block';
                else if (e.target.value === 'shape') shapeOptions.style.display = 'block';
                else if (e.target.value === 'image') imageOptions.style.display = 'block';
                else if (e.target.value === 'multiple') multipleOptions.style.display = 'block';
            });
            
            // Logo upload handler
            document.getElementById('logoUpload').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const previewImg = document.getElementById('logoPreviewImg');
                        previewImg.src = event.target.result;
                        previewImg.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // Logo size slider handler
            document.getElementById('logoSize').addEventListener('input', (e) => {
                document.getElementById('logoSizeValue').textContent = e.target.value + '%';
            });
            
            // Logo transparency slider handler
            document.getElementById('logoTransparency').addEventListener('input', (e) => {
                document.getElementById('logoTransparencyValue').textContent = e.target.value + '%';
            });
            
            // Aspect ratio handler
            document.getElementById('maintainAspectRatio').addEventListener('change', (e) => {
                const heightInput = document.getElementById('imageHeight');
                heightInput.disabled = e.target.checked;
                if (e.target.checked) {
                    heightInput.value = document.getElementById('imageWidth').value;
                }
            });
            
            // Resize mode explanation handler
            document.getElementById('resizeMode').addEventListener('change', updateResizeModeExplanation);
            
        // Initialize resize mode explanation on page load
        updateResizeModeExplanation();
        
        // Simple sidebar functionality
        function toggleSidebar() {
            console.log('Toggle sidebar called');
            const settingsPanel = document.getElementById('settingsPanel');
            const sidebarToggle = document.getElementById('sidebarToggleBtn');
            const mainContent = document.getElementById('mainContent');
            
            if (!settingsPanel || !sidebarToggle) {
                console.error('Sidebar elements not found');
                return;
            }
            
            const isOpen = settingsPanel.classList.contains('open');
            console.log('Sidebar is open:', isOpen);
            
            if (isOpen) {
                // Close sidebar
                settingsPanel.classList.remove('open');
                mainContent.classList.remove('sidebar-open');
                sidebarToggle.textContent = '‚ò∞';
                console.log('Sidebar closed');
            } else {
                // Open sidebar
                settingsPanel.classList.add('open');
                mainContent.classList.add('sidebar-open');
                sidebarToggle.textContent = '‚úï';
                console.log('Sidebar opened');
            }
        }
        
        // Add click handler directly to button
        document.getElementById('sidebarToggleBtn').onclick = toggleSidebar;
            
            // Width change handler for aspect ratio
            document.getElementById('imageWidth').addEventListener('input', (e) => {
                if (document.getElementById('maintainAspectRatio').checked) {
                    document.getElementById('imageHeight').value = e.target.value;
                }
            });
            
            // Additional image upload handler
            document.getElementById('additionalImageUpload').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const previewImg = document.getElementById('additionalImagePreviewImg');
                        previewImg.src = event.target.result;
                        previewImg.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // Shape transparency slider handler
            document.getElementById('shapeTransparency').addEventListener('input', (e) => {
                document.getElementById('shapeTransparencyValue').textContent = e.target.value + '%';
            });
            
            // Additional image size slider handler
            document.getElementById('additionalImageSize').addEventListener('input', (e) => {
                document.getElementById('additionalImageSizeValue').textContent = e.target.value + '%';
            });
            
            // Live preview button handler
            document.getElementById('previewBtn').addEventListener('click', openLivePreview);
            
            // Preview modal close handler
            document.getElementById('previewClose').addEventListener('click', () => {
                document.getElementById('previewModal').style.display = 'none';
            });
            
            // Preview controls handlers
            document.getElementById('previewX').addEventListener('input', updatePreview);
            document.getElementById('previewY').addEventListener('input', updatePreview);
            document.getElementById('previewSize').addEventListener('input', updatePreview);
            document.getElementById('previewRotation').addEventListener('input', updatePreview);
            
            // Apply and reset preview handlers
            document.getElementById('saveSettingsBtn').addEventListener('click', saveSettings);
            document.getElementById('resetPreviewBtn').addEventListener('click', resetPreviewSettings);
            
            // Margin slider handlers
            document.getElementById('marginTop').addEventListener('input', (e) => {
                document.getElementById('marginTopValue').textContent = e.target.value + 'px';
            });
            
            document.getElementById('marginBottom').addEventListener('input', (e) => {
                document.getElementById('marginBottomValue').textContent = e.target.value + 'px';
            });
            
            document.getElementById('marginLeft').addEventListener('input', (e) => {
                document.getElementById('marginLeftValue').textContent = e.target.value + 'px';
            });
            
            document.getElementById('marginRight').addEventListener('input', (e) => {
                document.getElementById('marginRightValue').textContent = e.target.value + 'px';
            });
            
            // Auto center handler
            document.getElementById('autoCenter').addEventListener('change', (e) => {
                if (e.target.checked) {
                    // Reset margins to equal values for centering
                    const marginValue = 200;
                    document.getElementById('marginTop').value = marginValue;
                    document.getElementById('marginBottom').value = marginValue;
                    document.getElementById('marginLeft').value = marginValue;
                    document.getElementById('marginRight').value = marginValue;
                    
                    // Update display values
                    document.getElementById('marginTopValue').textContent = marginValue + 'px';
                    document.getElementById('marginBottomValue').textContent = marginValue + 'px';
                    document.getElementById('marginLeftValue').textContent = marginValue + 'px';
                    document.getElementById('marginRightValue').textContent = marginValue + 'px';
                }
            });
        });
        
        function openImageModal(imageSrc) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            modalImg.src = imageSrc;
            modal.style.display = 'block';
        }
        
        // Simplified Preview Variables
        let previewSettings = {
            backgroundColor: '#ffffff',
            removeBackground: false,
            autoCenter: true,
            marginTop: 200,
            marginBottom: 200,
            marginLeft: 200,
            marginRight: 200,
            logoData: null,
            logoSize: 50,
            logoTransparency: 80,
            logoPosition: 'center'
        };
        
        // Preview variables
        let previewLogoData = null;
        
        function openLivePreview() {
            // Get a sample image
            let sampleImage = null;
            const selectedImages = document.querySelectorAll('.product img.selected');
            if (selectedImages.length > 0) {
                sampleImage = selectedImages[0].src;
            } else {
                const firstImage = document.querySelector('.product img');
                if (firstImage) {
                    sampleImage = firstImage.src;
                }
            }
            
            if (!sampleImage) {
                sampleImage = 'https://images.unsplash.com/photo-1523275335684-37898b6baf30?w=400&h=400&fit=crop&crop=center';
                log('üì∑ Using sample product image for preview');
            }
            
            // Set up preview
            document.getElementById('previewImage').src = sampleImage;
            document.getElementById('previewStatus').textContent = 'Loading...';
            
            // Load current settings
            loadCurrentSettings();
            
            // Show modal
            document.getElementById('previewModal').style.display = 'block';
            
            // Update preview after image loads
            document.getElementById('previewImage').onload = function() {
                document.getElementById('previewStatus').textContent = 'Ready';
                updatePreview();
            };
            
            setTimeout(() => {
                updatePreview();
            }, 100);
            
            log('üé® Opened Visual Settings Designer');
        }
        
        function loadCurrentSettings() {
            // Load current form settings into preview controls
            document.getElementById('previewBackgroundColor').value = document.getElementById('backgroundColor').value;
            document.getElementById('previewRemoveBackground').checked = document.getElementById('removeBackground').checked;
            document.getElementById('previewRemoveLogos').checked = document.getElementById('removeLogos').checked;
            document.getElementById('previewAutoCenter').checked = document.getElementById('autoCenter').checked || true;
            document.getElementById('previewMarginTop').value = document.getElementById('marginTop').value || 200;
            document.getElementById('previewMarginBottom').value = document.getElementById('marginBottom').value || 200;
            document.getElementById('previewMarginLeft').value = document.getElementById('marginLeft').value || 200;
            document.getElementById('previewMarginRight').value = document.getElementById('marginRight').value || 200;
            
            updatePreviewValueDisplays();
            updateWatermarkControls();
        }
        
        function updatePreviewValueDisplays() {
            document.getElementById('previewMarginTopValue').textContent = document.getElementById('previewMarginTop').value + 'px';
            document.getElementById('previewMarginBottomValue').textContent = document.getElementById('previewMarginBottom').value + 'px';
            document.getElementById('previewMarginLeftValue').textContent = document.getElementById('previewMarginLeft').value + 'px';
            document.getElementById('previewMarginRightValue').textContent = document.getElementById('previewMarginRight').value + 'px';
        }
        
        function updateWatermarkControls() {
            const type = document.getElementById('previewWatermarkType').value;
            const textControls = document.getElementById('textControls');
            const logoControls = document.getElementById('logoControls');
            const positionControls = document.getElementById('positionControls');
            
            textControls.style.display = 'none';
            logoControls.style.display = 'none';
            positionControls.style.display = 'none';
            
            if (type === 'text') {
                textControls.style.display = 'block';
                positionControls.style.display = 'block';
            } else if (type === 'logo') {
                logoControls.style.display = 'block';
                positionControls.style.display = 'block';
            }
        }
        
        function handleLogoUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewLogoData = e.target.result;
                    updatePreview();
                };
                reader.readAsDataURL(input.files[0]);
            }
        }
        
        function updateResizeModeExplanation() {
            const resizeMode = document.getElementById('resizeMode').value;
            const explanation = document.getElementById('resizeModeExplanation');
            
            console.log('updateResizeModeExplanation called with:', resizeMode);
            
            if (!explanation) {
                console.error('resizeModeExplanation element not found');
                return;
            }
            
            const explanations = {
                'contain': '<strong>Contain:</strong> Fits entire image within bounds, may show empty space. Best for showing complete product without cropping.',
                'cover': '<strong>Cover:</strong> Fills entire bounds, may crop parts of image. Best for filling the canvas completely.',
                'fill': '<strong>Fill:</strong> Stretches image to fill bounds, may distort aspect ratio. Use with caution as it can make products look stretched.',
                'inside': '<strong>Inside:</strong> Similar to contain, ensures image fits completely within bounds. Good for maintaining quality.',
                'outside': '<strong>Outside:</strong> Similar to cover, ensures bounds are filled. May crop image but fills the space.'
            };
            
            explanation.innerHTML = explanations[resizeMode] || explanations['contain'];
            console.log('Updated explanation for:', resizeMode);
        }

        function updatePreview() {
            const overlay = document.getElementById('previewOverlay');
            if (!overlay) return;
            
            overlay.innerHTML = '';
            
            const type = document.getElementById('previewWatermarkType').value;
            if (type === 'none') return;
            
            const position = document.getElementById('previewWatermarkPosition').value;
            
            if (type === 'text') {
                const text = document.getElementById('previewWatermarkText').value;
                if (!text) return;
                
                const color = document.getElementById('previewWatermarkColor').value;
                const size = document.getElementById('previewWatermarkSize').value;
                
                const textEl = document.createElement('div');
                textEl.textContent = text;
                textEl.style.cssText = `
                    position: absolute;
                    color: ${color};
                    font-size: ${size}px;
                    font-weight: bold;
                    text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
                    pointer-events: none;
                    z-index: 20;
                `;
                
                setElementPosition(textEl, position);
                overlay.appendChild(textEl);
                
            } else if (type === 'logo' && previewLogoData) {
                const logoSize = document.getElementById('previewLogoSize').value;
                const transparency = document.getElementById('previewLogoTransparency').value;
                
                const logoEl = document.createElement('img');
                logoEl.src = previewLogoData;
                logoEl.style.cssText = `
                    position: absolute;
                    max-width: ${logoSize}%;
                    max-height: ${logoSize}%;
                    opacity: ${(100 - transparency) / 100};
                    pointer-events: none;
                    z-index: 20;
                `;
                
                setElementPosition(logoEl, position);
                overlay.appendChild(logoEl);
            }
        }
        
        function setElementPosition(element, position) {
            switch (position) {
                case 'top-left':
                    element.style.top = '10px';
                    element.style.left = '10px';
                    break;
                case 'top-center':
                    element.style.top = '10px';
                    element.style.left = '50%';
                    element.style.transform = 'translateX(-50%)';
                    break;
                case 'top-right':
                    element.style.top = '10px';
                    element.style.right = '10px';
                    break;
                case 'center-left':
                    element.style.top = '50%';
                    element.style.left = '10px';
                    element.style.transform = 'translateY(-50%)';
                    break;
                case 'center':
                    element.style.top = '50%';
                    element.style.left = '50%';
                    element.style.transform = 'translate(-50%, -50%)';
                    break;
                case 'center-right':
                    element.style.top = '50%';
                    element.style.right = '10px';
                    element.style.transform = 'translateY(-50%)';
                    break;
                case 'bottom-left':
                    element.style.bottom = '10px';
                    element.style.left = '10px';
                    break;
                case 'bottom-center':
                    element.style.bottom = '10px';
                    element.style.left = '50%';
                    element.style.transform = 'translateX(-50%)';
                    break;
                case 'bottom-right':
                default:
                    element.style.bottom = '10px';
                    element.style.right = '10px';
                    break;
            }
        }
        
        function resetPreviewSettings() {
            document.getElementById('previewBackgroundColor').value = '#ffffff';
            document.getElementById('previewRemoveBackground').checked = false;
            document.getElementById('previewRemoveLogos').checked = false;
            document.getElementById('previewAutoCenter').checked = true;
            document.getElementById('previewMarginTop').value = 200;
            document.getElementById('previewMarginBottom').value = 200;
            document.getElementById('previewMarginLeft').value = 200;
            document.getElementById('previewMarginRight').value = 200;
            document.getElementById('previewWatermarkType').value = 'none';
            document.getElementById('previewWatermarkText').value = '';
            document.getElementById('previewWatermarkColor').value = '#ffffff';
            document.getElementById('previewWatermarkSize').value = 48;
            document.getElementById('previewLogoSize').value = 50;
            document.getElementById('previewLogoTransparency').value = 20;
            document.getElementById('previewWatermarkPosition').value = 'bottom-right';
            
            previewLogoData = null;
            updatePreviewValueDisplays();
            updateWatermarkControls();
            updatePreview();
        }
        
        function savePreviewSettings() {
            // Apply settings to main form
            document.getElementById('backgroundColor').value = document.getElementById('previewBackgroundColor').value;
            document.getElementById('removeBackground').checked = document.getElementById('previewRemoveBackground').checked;
            document.getElementById('removeLogos').checked = document.getElementById('previewRemoveLogos').checked;
            document.getElementById('autoCenter').checked = document.getElementById('previewAutoCenter').checked;
            document.getElementById('marginTop').value = document.getElementById('previewMarginTop').value;
            document.getElementById('marginBottom').value = document.getElementById('previewMarginBottom').value;
            document.getElementById('marginLeft').value = document.getElementById('previewMarginLeft').value;
            document.getElementById('marginRight').value = document.getElementById('previewMarginRight').value;
            
            const type = document.getElementById('previewWatermarkType').value;
            if (type === 'text') {
                document.getElementById('watermarkType').value = 'text';
                document.getElementById('watermarkText').value = document.getElementById('previewWatermarkText').value;
                document.getElementById('watermarkColor').value = document.getElementById('previewWatermarkColor').value;
                document.getElementById('watermarkSize').value = document.getElementById('previewWatermarkSize').value;
                document.getElementById('watermarkPosition').value = document.getElementById('previewWatermarkPosition').value;
            } else if (type === 'logo') {
                document.getElementById('watermarkType').value = 'logo';
                document.getElementById('logoSize').value = document.getElementById('previewLogoSize').value;
                document.getElementById('logoTransparency').value = document.getElementById('previewLogoTransparency').value;
                document.getElementById('logoPosition').value = document.getElementById('previewWatermarkPosition').value;
                if (previewLogoData) {
                    let logoField = document.getElementById('logoData');
                    if (!logoField) {
                        logoField = document.createElement('input');
                        logoField.type = 'hidden';
                        logoField.id = 'logoData';
                        document.body.appendChild(logoField);
                    }
                    logoField.value = previewLogoData;
                }
            } else {
                document.getElementById('watermarkType').value = 'none';
            }
            
            document.getElementById('previewModal').style.display = 'none';
            log('üé® Visual settings applied successfully!');
        }
        
        // Image selection functionality
        function toggleImageSelection(img) {
            img.classList.toggle('selected');
            updateProcessButtonText();
        }
        
        function updateProcessButtonText() {
            const selectedImages = document.querySelectorAll('.product img.selected');
            const processBtn = document.getElementById('processImagesBtn');
            if (processBtn) {
                if (selectedImages.length === 0) {
                    processBtn.textContent = 'Process Selected Images';
                    processBtn.disabled = true;
                } else {
                    processBtn.textContent = `Process Selected Images (${selectedImages.length})`;
                    processBtn.disabled = false;
                }
            }
        }
        
        // Process selected images functionality
        async function processSelectedImages() {
            const selectedImages = document.querySelectorAll('.product img.selected');
            if (selectedImages.length === 0) {
                alert('Please select at least one image to process');
                return;
            }

            log('üöÄ System ready', 'system');
            log(`üöÄ Starting processing of ${selectedImages.length} selected images...`, 'processing');

            // Get settings from form
            const settings = {
                bulkRenameOnly: document.getElementById('bulkRenameOnly').checked,
                updateAltText: document.getElementById('updateAltText').checked,
                removeBackground: document.getElementById('removeBackground').checked,
                removeLogos: document.getElementById('removeLogos').checked,
                backgroundColor: document.getElementById('backgroundColor').value,
                imageWidth: parseInt(document.getElementById('imageWidth').value),
                imageHeight: parseInt(document.getElementById('imageHeight').value),
                maintainAspectRatio: document.getElementById('maintainAspectRatio').checked,
                resizeMode: document.getElementById('resizeMode').value,
                imageQuality: parseInt(document.getElementById('imageQuality').value),
                imageFormat: document.getElementById('imageFormat').value,
                imageUploadMode: document.getElementById('imageUploadMode').value,
                autoCenter: document.getElementById('autoCenter').checked,
                aiUpscaling: document.getElementById('aiUpscaling').checked,
                marginTop: parseInt(document.getElementById('marginTop').value),
                marginBottom: parseInt(document.getElementById('marginBottom').value),
                marginLeft: parseInt(document.getElementById('marginLeft').value),
                marginRight: parseInt(document.getElementById('marginRight').value),
                watermarkType: document.getElementById('watermarkType').value,
                watermarkText: document.getElementById('watermarkText').value,
                watermarkColor: document.getElementById('watermarkColor').value,
                watermarkSize: parseInt(document.getElementById('watermarkSize').value),
                watermarkPosition: document.getElementById('watermarkPosition').value,
                logoSize: parseInt(document.getElementById('logoSize').value),
                logoTransparency: parseInt(document.getElementById('logoTransparency').value),
                logoPosition: document.getElementById('logoPosition').value
            };

            // If bulk rename only, send minimal settings to avoid any processing
            if (settings.bulkRenameOnly) {
                settings.removeBackground = false;
                settings.removeLogos = false;
                settings.aiUpscaling = false;
                settings.watermarkType = 'none';
                settings.logoData = null;
            }

            // Include logo data if available
            const logoData = document.getElementById('logoData');
            if (logoData && logoData.value) {
                settings.logoData = logoData.value;
            }

            const processBtn = document.getElementById('processImagesBtn');
            const originalText = processBtn.textContent;
            processBtn.disabled = true;
            processBtn.textContent = 'Processing...';

            try {
                let processedCount = 0;
                for (const img of selectedImages) {
                    processedCount++;
                    processBtn.textContent = `Processing ${processedCount}/${selectedImages.length}...`;
                    
                    const productId = img.closest('.product').dataset.productId;
                    const imageUrl = img.src;
                    const imageId = img.dataset.imageId; // Get image ID from data attribute
                    
                    // Get image index (position in product's image array)
                    const productImages = img.closest('.product').querySelectorAll('img');
                    const imageIndex = Array.from(productImages).indexOf(img) + 1;

                    log(`üì∏ Processing image ${processedCount}/${selectedImages.length}: ${imageUrl}`, 'processing');
                    log(`üîß Applying settings: ${JSON.stringify(settings).substring(0, 100)}...`, 'processing');

                    const response = await fetch('/api/process-image', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            productId: productId,
                            imageUrl: imageUrl,
                            imageId: imageId, // Include image ID for replace/hide modes
                            imageIndex: imageIndex, // Include image index for filename
                            settings: settings
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        log(`‚úÖ Successfully processed image ${processedCount}/${selectedImages.length}`, 'success');
                        log(`üì§ Uploaded processed image to Shopify`, 'success');
                        
                        // Remove selection from processed image
                        img.classList.remove('selected');
                    } else {
                        const error = await response.text();
                        log(`‚ùå Failed to process image ${processedCount}/${selectedImages.length}: ${error}`, 'error');
                    }
                }

                log(`üéâ Completed processing ${processedCount} images!`, 'success');
                log(`üìä Processing summary: ${processedCount} images processed successfully`, 'success');
                updateProcessButtonText();

            } catch (error) {
                log(`‚ùå Error during processing: ${error.message}`, 'error');
            } finally {
                processBtn.disabled = false;
                processBtn.textContent = originalText;
            }
        }

        async function deleteSelectedImages() {
            const selectedImages = document.querySelectorAll('.product img.selected');
            if (selectedImages.length === 0) {
                alert('Please select at least one image to delete');
                return;
            }

            const confirmed = confirm(`Are you sure you want to delete ${selectedImages.length} selected images from Shopify? This cannot be undone.`);
            if (!confirmed) {
                return;
            }

            log(`üóëÔ∏è Starting deletion of ${selectedImages.length} selected images...`);

            const deleteBtn = document.getElementById('deleteImagesBtn');
            const originalText = deleteBtn.textContent;
            deleteBtn.disabled = true;
            deleteBtn.textContent = 'Deleting...';

            try {
                let deletedCount = 0;
                for (const img of selectedImages) {
                    deletedCount++;
                    deleteBtn.textContent = `Deleting ${deletedCount}/${selectedImages.length}...`;
                    
                    const productId = img.closest('.product').dataset.productId;
                    const imageId = img.dataset.imageId;

                    if (!imageId) {
                        log(`‚ö†Ô∏è Skipping image ${deletedCount}/${selectedImages.length}: No image ID found`);
                        continue;
                    }

                    log(`üóëÔ∏è Deleting image ${deletedCount}/${selectedImages.length} from product ${productId}...`);

                    const response = await fetch('/api/delete-image', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            productId: productId,
                            imageId: imageId
                        })
                    });

                    if (response.ok) {
                        log(`‚úÖ Successfully deleted image ${deletedCount}/${selectedImages.length}`);
                        
                        // Remove the image element from the DOM
                        img.remove();
                    } else {
                        const error = await response.text();
                        log(`‚ùå Failed to delete image ${deletedCount}/${selectedImages.length}: ${error}`);
                    }
                }

                log(`üéâ Completed deleting ${deletedCount} images!`);
                updateProcessButtonText();

            } catch (error) {
                log(`‚ùå Error during deletion: ${error.message}`);
            } finally {
                deleteBtn.disabled = false;
                deleteBtn.textContent = originalText;
            }
        }

        // Settings Profile Management
        function getCurrentSettings() {
            const logoData = document.getElementById('logoData');
            return {
                bulkRenameOnly: document.getElementById('bulkRenameOnly').checked,
                removeBackground: document.getElementById('removeBackground').checked,
                removeLogos: document.getElementById('removeLogos').checked,
                backgroundColor: document.getElementById('backgroundColor').value,
                imageWidth: parseInt(document.getElementById('imageWidth').value),
                imageHeight: parseInt(document.getElementById('imageHeight').value),
                maintainAspectRatio: document.getElementById('maintainAspectRatio').checked,
                resizeMode: document.getElementById('resizeMode').value,
                imageQuality: parseInt(document.getElementById('imageQuality').value),
                imageFormat: document.getElementById('imageFormat').value,
                imageUploadMode: document.getElementById('imageUploadMode').value,
                autoCenter: document.getElementById('autoCenter').checked,
                aiUpscaling: document.getElementById('aiUpscaling').checked,
                marginTop: parseInt(document.getElementById('marginTop').value),
                marginBottom: parseInt(document.getElementById('marginBottom').value),
                marginLeft: parseInt(document.getElementById('marginLeft').value),
                marginRight: parseInt(document.getElementById('marginRight').value),
                watermarkType: document.getElementById('watermarkType').value,
                watermarkText: document.getElementById('watermarkText').value,
                watermarkColor: document.getElementById('watermarkColor').value,
                watermarkSize: parseInt(document.getElementById('watermarkSize').value),
                watermarkPosition: document.getElementById('watermarkPosition').value,
                logoSize: parseInt(document.getElementById('logoSize').value),
                logoTransparency: parseInt(document.getElementById('logoTransparency').value),
                logoPosition: document.getElementById('logoPosition').value,
                logoData: logoData && logoData.value ? logoData.value : null
            };
        }

        function applySettings(settings) {
            document.getElementById('removeBackground').checked = settings.removeBackground;
            document.getElementById('removeLogos').checked = settings.removeLogos;
            document.getElementById('backgroundColor').value = settings.backgroundColor;
            document.getElementById('backgroundColorText').value = settings.backgroundColor;
            document.getElementById('imageWidth').value = settings.imageWidth;
            document.getElementById('imageHeight').value = settings.imageHeight;
            document.getElementById('maintainAspectRatio').checked = settings.maintainAspectRatio;
            document.getElementById('resizeMode').value = settings.resizeMode;
            document.getElementById('imageQuality').value = settings.imageQuality;
            document.getElementById('imageFormat').value = settings.imageFormat;
            document.getElementById('imageUploadMode').value = settings.imageUploadMode;
            document.getElementById('autoCenter').checked = settings.autoCenter;
            document.getElementById('aiUpscaling').checked = settings.aiUpscaling;
            document.getElementById('marginTop').value = settings.marginTop;
            document.getElementById('marginBottom').value = settings.marginBottom;
            document.getElementById('marginLeft').value = settings.marginLeft;
            document.getElementById('marginRight').value = settings.marginRight;
            document.getElementById('logoSize').value = settings.logoSize;
            document.getElementById('logoTransparency').value = settings.logoTransparency;
            document.getElementById('logoPosition').value = settings.logoPosition;
            
            // Restore watermark type and related settings
            if (settings.watermarkType) {
                document.getElementById('watermarkType').value = settings.watermarkType;
                if (settings.watermarkText) document.getElementById('watermarkText').value = settings.watermarkText;
                if (settings.watermarkColor) document.getElementById('watermarkColor').value = settings.watermarkColor;
                if (settings.watermarkSize) document.getElementById('watermarkSize').value = settings.watermarkSize;
                if (settings.watermarkPosition) document.getElementById('watermarkPosition').value = settings.watermarkPosition;
            }
            
            // Restore logo if saved
            const logoData = document.getElementById('logoData');
            if (logoData && settings.logoData) {
                logoData.value = settings.logoData;
                // Also restore preview logo data for Visual Designer
                previewLogoData = settings.logoData;
                log('‚úÖ Logo restored from profile');
            } else if (logoData && !settings.logoData) {
                logoData.value = '';
                previewLogoData = null;
                log('‚ÑπÔ∏è No logo in this profile');
            }
            
            // Also update Visual Designer (preview) settings
            const previewWatermarkType = document.getElementById('previewWatermarkType');
            const previewLogoSize = document.getElementById('previewLogoSize');
            const previewLogoTransparency = document.getElementById('previewLogoTransparency');
            const previewLogoPosition = document.getElementById('previewWatermarkPosition');
            
            // Set watermark type in preview
            if (previewWatermarkType && settings.watermarkType) {
                previewWatermarkType.value = settings.watermarkType;
                // Trigger the change event to show/hide appropriate controls
                previewWatermarkType.dispatchEvent(new Event('change'));
            }
            
            if (previewLogoSize) {
                previewLogoSize.value = settings.logoSize;
                document.getElementById('previewLogoSizeValue').textContent = settings.logoSize + '%';
            }
            if (previewLogoTransparency) {
                previewLogoTransparency.value = settings.logoTransparency;
                document.getElementById('previewLogoTransparencyValue').textContent = settings.logoTransparency + '%';
            }
            if (previewLogoPosition) {
                previewLogoPosition.value = settings.logoPosition;
            }
        }

        function saveProfile() {
            const profileName = document.getElementById('newProfileName').value.trim();
            if (!profileName) {
                alert('Please enter a profile name');
                return;
            }

            const settings = getCurrentSettings();
            console.log('Saving profile:', profileName, settings);
            const profiles = JSON.parse(localStorage.getItem('settingsProfiles') || '{}');
            profiles[profileName] = settings;
            localStorage.setItem('settingsProfiles', JSON.stringify(profiles));
            
            document.getElementById('newProfileName').value = '';
            document.getElementById('settingsProfile').value = profileName;
            loadProfilesList();
            log(`üíæ Saved profile: ${profileName} (Watermark: ${settings.watermarkType}, Margins: T${settings.marginTop} R${settings.marginRight} B${settings.marginBottom} L${settings.marginLeft}, Logo: ${settings.logoSize}%, Transparency: ${settings.logoTransparency}%, Position: ${settings.logoPosition})`);
        }

        function loadProfile() {
            const profileName = document.getElementById('settingsProfile').value;
            if (!profileName) {
                alert('Please select a profile to load');
                return;
            }

            const profiles = JSON.parse(localStorage.getItem('settingsProfiles') || '{}');
            const settings = profiles[profileName];
            
            console.log('Loading profile:', profileName, settings);
            
            if (settings) {
                applySettings(settings);
                log(`üìÇ Loaded profile: ${profileName} (Watermark: ${settings.watermarkType}, Margins: T${settings.marginTop} R${settings.marginRight} B${settings.marginBottom} L${settings.marginLeft}, Logo: ${settings.logoSize}%, Transparency: ${settings.logoTransparency}%, Position: ${settings.logoPosition})`);
            } else {
                alert('Profile not found');
            }
        }

        function deleteProfile() {
            const profileName = document.getElementById('settingsProfile').value;
            if (!profileName) {
                alert('Please select a profile to delete');
                return;
            }

            const confirmed = confirm(`Delete profile "${profileName}"?`);
            if (!confirmed) return;

            const profiles = JSON.parse(localStorage.getItem('settingsProfiles') || '{}');
            delete profiles[profileName];
            localStorage.setItem('settingsProfiles', JSON.stringify(profiles));
            
            loadProfilesList();
            log(`üóëÔ∏è Deleted profile: ${profileName}`);
        }

        function loadProfilesList() {
            const profiles = JSON.parse(localStorage.getItem('settingsProfiles') || '{}');
            const select = document.getElementById('settingsProfile');
            
            select.innerHTML = '<option value="">Select a profile...</option>';
            Object.keys(profiles).forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                select.appendChild(option);
            });
        }
        
        // Event listeners setup
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, setting up all event listeners...');
            
            // Sidebar functionality
            const settingsPanel = document.getElementById('settingsPanel');
            const sidebarToggle = document.getElementById('sidebarToggleBtn');
            const closeSettings = document.getElementById('closeSettingsBtn');
            const settingsOverlay = document.getElementById('settingsOverlay');
            const mainContent = document.getElementById('mainContent');
            
            console.log('Sidebar elements:', {
                settingsPanel: !!settingsPanel,
                sidebarToggle: !!sidebarToggle,
                closeSettings: !!closeSettings,
                settingsOverlay: !!settingsOverlay,
                mainContent: !!mainContent
            });
            
            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('Sidebar toggle clicked');
                    const isOpen = settingsPanel.classList.contains('open');
                    
                    if (isOpen) {
                        settingsPanel.classList.remove('open');
                        mainContent.classList.remove('sidebar-open');
                        sidebarToggle.textContent = '‚ò∞';
                        console.log('Sidebar closed');
                    } else {
                        settingsPanel.classList.add('open');
                        mainContent.classList.add('sidebar-open');
                        sidebarToggle.textContent = '‚úï';
                        console.log('Sidebar opened');
                    }
                });
            }
            
            if (closeSettings) {
                closeSettings.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('Close settings clicked');
                    settingsPanel.classList.remove('open');
                    mainContent.classList.remove('sidebar-open');
                    sidebarToggle.textContent = '‚ò∞';
                });
            }
            
            if (settingsOverlay) {
                settingsOverlay.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('Overlay clicked');
                    settingsPanel.classList.remove('open');
                    mainContent.classList.remove('sidebar-open');
                    sidebarToggle.textContent = '‚ò∞';
                });
            }
            
            // Close button
            const closeBtn = document.getElementById('previewClose');
            if (closeBtn) {
                closeBtn.addEventListener('click', function() {
                    document.getElementById('previewModal').style.display = 'none';
                });
            }
            
            // Close modal when clicking outside
            const modal = document.getElementById('previewModal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal.firstElementChild) {
                        modal.style.display = 'none';
                    }
                });
            }
            
            // Watermark type change handler
            const watermarkTypeSelect = document.getElementById('previewWatermarkType');
            if (watermarkTypeSelect) {
                watermarkTypeSelect.addEventListener('change', updateWatermarkControls);
            }
        });
    </script>
</body>
</html>
